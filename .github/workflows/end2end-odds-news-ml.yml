name: End2End Odds + News + ML

on:
  workflow_dispatch:
    inputs:
      RODADA:
        description: "Identificador da rodada (ex: 2025-10-04_1214)"
        required: true
      SEASON:
        description: "Ano da temporada"
        required: true
        default: "2025"

jobs:
  end2end:
    runs-on: ubuntu-latest
    env:
      RODADA: ${{ github.event.inputs.RODADA }}
      SEASON: ${{ github.event.inputs.SEASON }}
      REGIONS: uk,eu,us,au
      BANKROLL: 1000.0
      KELLY_FRACTION: 0.5
      KELLY_CAP: 0.1
      ROUND_TO: 1.0
      KELLY_TOP_N: 14.0
      DEBUG: true
      THEODDS_API_KEY: ${{ secrets.THEODDS_API_KEY }}
      X_RAPIDAPI_KEY: ${{ secrets.X_RAPIDAPI_KEY }}
      NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
      WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
      APIFOOT_LEAGUE_IDS: 71,72

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Sanity check entrada
        run: |
          set -e
          FILE="data/in/matches_source.csv"
          if [ ! -f "$FILE" ]; then
            echo "::error::Arquivo $FILE não encontrado."
            exit 2
          fi
          echo "Entrada OK: $FILE"
          echo "Preview:"
          head -n 5 "$FILE" || true

      - name: TheOddsAPI ingest
        run: |
          set -e
          EXTRA=""
          [ "${DEBUG}" = "true" ] && EXTRA="--debug" || true
          python scripts/ingest_odds_theoddsapi_safe.py \
            --rodada "${RODADA}" \
            --regions "${REGIONS}" \
            ${EXTRA}

      - name: API-Football ingest
        run: |
          set -e
          EXTRA=""
          [ "${DEBUG}" = "true" ] && EXTRA="--debug" || true
          python -m scripts.ingest_odds_apifootball_rapidapi \
            --rodada "${RODADA}" \
            --season "${SEASON}" \
            --window 2 \
            --fuzzy 0.90 \
            --aliases data/aliases_br.json \
            ${EXTRA} || true

      - name: Consensus Odds
        run: |
          set -e
          python -m scripts.consensus_odds_safe --rodada "${RODADA}"

      - name: Market Predictions
        run: |
          set -e
          python scripts/predict_from_odds.py --rodada "${RODADA}"

      - name: News ingest
        run: |
          set -e
          python scripts/news_ingest_safe.py || true

      - name: Injuries ingest
        run: |
          set -e
          python scripts/injuries_apifootball_safe.py || true

      - name: XG Univariado
        run: |
          set -e
          python scripts/ml_xg_univariado.py --rodada "${RODADA}" --season "${SEASON}" || true

      - name: XG Bivariado
        run: |
          set -e
          python scripts/ml_xg_bivariado.py --rodada "${RODADA}" --season "${SEASON}" || true

      - name: Calibração Isotônica
        run: |
          set -e
          python scripts/ml_calibracao_isotonica.py --rodada "${RODADA}" --season "${SEASON}" || true

      - name: Stacking Bivariado
        run: |
          set -e
          python scripts/ml_stacking_bivariado.py --rodada "${RODADA}" --season "${SEASON}" || true

      - name: Build Cartão
        run: |
          set -e
          python scripts/build_cartao.py --rodada "${RODADA}"

      - name: Kelly Stakes
        run: |
          set -e
          python scripts/publish_kelly.py --rodada "${RODADA}"

      - name: Sanity Reality Check
        run: |
          set -e
          python scripts/sanity_reality_check.py --rodada "${RODADA}" --strict

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: loteca_full_${{ env.RODADA }}
          path: |
            data/out/${{ env.RODADA }}/*