name: Loteca Pipeline

on:
  workflow_dispatch:
    inputs:
      rodada:
        description: "Identificador da rodada (ex.: 2025-09-20_21)"
        required: true
        type: string
  push:
    branches: ["main"]
    paths:
      - "scripts/**"
      - ".github/workflows/loteca_pipeline.yml"

jobs:
  build-loteca:
    runs-on: ubuntu-latest
    env:
      LOTECA_RODADA: ${{ inputs.rodada }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install pandas

      - name: Ingest matches
        run: |
          python scripts/ingest_matches.py --rodada "${LOTECA_RODADA}"
          test -s "data/out/${LOTECA_RODADA}/matches.csv" || { echo "::error::matches.csv ausente ou vazio"; exit 2; }
          wc -l "data/out/${LOTECA_RODADA}/matches.csv" || true
          head -n 3 "data/out/${LOTECA_RODADA}/matches.csv" || true

      - name: Ingest odds
        run: |
          python scripts/ingest_odds.py --rodada "${LOTECA_RODADA}"
          test -s "data/out/${LOTECA_RODADA}/odds.csv" || { echo "::error::odds.csv ausente ou vazio"; exit 2; }
          wc -l "data/out/${LOTECA_RODADA}/odds.csv" || true
          head -n 3 "data/out/${LOTECA_RODADA}/odds.csv" || true

      - name: Build features
        run: |
          python scripts/build_features.py --rodada "${LOTECA_RODADA}"
          test -s "data/out/${LOTECA_RODADA}/features.csv" || { echo "::error::features.csv ausente ou vazio"; exit 2; }
          wc -l "data/out/${LOTECA_RODADA}/features.csv" || true
          head -n 3 "data/out/${LOTECA_RODADA}/features.csv" || true

      - name: Join features
        run: |
          # Ative soft-mode se quiser que N√ÉO QUEBRE quando matches estiver vazio:
          # export JOIN_SOFT=1
          python scripts/join_features.py --rodada "${LOTECA_RODADA}"
          test -s "data/out/${LOTECA_RODADA}/joined.csv" || { echo "::error::joined.csv ausente ou vazio"; exit 2; }
          wc -l "data/out/${LOTECA_RODADA}/joined.csv" || true
          head -n 3 "data/out/${LOTECA_RODADA}/joined.csv" || true

      - name: Upload joined
        uses: actions/upload-artifact@v4
        with:
          name: joined-${{ env.LOTECA_RODADA }}
          path: data/out/${{ env.LOTECA_RODADA }}/joined.csv
