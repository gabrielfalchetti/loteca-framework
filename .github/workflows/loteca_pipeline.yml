name: Loteca Pipeline (MULTI-LIGAS + CARTÃO + RapidAPI)

on:
  workflow_dispatch:
    inputs:
      rodada:
        description: "Identificador da rodada (ex.: 2025-10-05_14)"
        required: true
        default: "2025-10-05_14"

jobs:
  build-loteca:
    runs-on: ubuntu-latest
    env:
      LOTECA_RODADA: ${{ github.event.inputs.rodada }}
      ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests rapidfuzz==3.9.7 PyYAML==6.0.2

      - name: Ingest matches
        run: |
          python scripts/ingest_matches.py --rodada "${{ env.LOTECA_RODADA }}"
          test -s "data/out/${{ env.LOTECA_RODADA }}/matches.csv" || { echo "::error::matches.csv ausente/vazio"; exit 2; }

      # Odds reais via TheOddsAPI (BR/EPL/LaLiga)
      - name: Ingest odds Brasil (Série A)
        env: { ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }} }
        run: |
          python scripts/ingest_odds.py --rodada "${{ env.LOTECA_RODADA }}" \
            --sport soccer_brazil_campeonato --regions uk,eu --market h2h \
            --min-match 88 --allow-partial
          mv "data/out/${{ env.LOTECA_RODADA }}/odds.csv" "data/out/${{ env.LOTECA_RODADA }}/odds_br.csv" || true

      - name: Ingest odds Inglaterra (EPL)
        env: { ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }} }
        run: |
          python scripts/ingest_odds.py --rodada "${{ env.LOTECA_RODADA }}" \
            --sport soccer_epl --regions uk,eu --market h2h --min-match 88 --allow-partial
          mv "data/out/${{ env.LOTECA_RODADA }}/odds.csv" "data/out/${{ env.LOTECA_RODADA }}/odds_epl.csv" || true

      - name: Ingest odds Espanha (La Liga)
        env: { ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }} }
        run: |
          python scripts/ingest_odds.py --rodada "${{ env.LOTECA_RODADA }}" \
            --sport soccer_spain_la_liga --regions uk,eu --market h2h \
            --min-match 88 --allow-partial
          mv "data/out/${{ env.LOTECA_RODADA }}/odds.csv" "data/out/${{ env.LOTECA_RODADA }}/odds_esp.csv" || true

      # Odds complementares via RapidAPI (API-Football) para cobrir Copas/regionais/Série B etc.
      - name: Ingest odds (RapidAPI - API-Football)
        env: { RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }} }
        run: |
          if [ -n "${RAPIDAPI_KEY}" ]; then
            python scripts/ingest_odds_apifootball_rapidapi.py --rodada "${{ env.LOTECA_RODADA }}" --allow-partial --country-hint "Brazil"
          else
            echo "RAPIDAPI_KEY não definido; pulando passo API-Football."
          fi

      # Merge de todas as fontes em data/out/<RODADA>/odds.csv
      - name: Merge odds
        run: |
          set -e
          BASE="data/out/${{ env.LOTECA_RODADA }}"
          OUT="${BASE}/odds.csv"
          TMP="${BASE}/odds_tmp.csv"
          : > "${OUT}"
          for f in "${BASE}/odds_br.csv" "${BASE}/odds_epl.csv" "${BASE}/odds_esp.csv" "${BASE}/odds_apifootball.csv"; do
            if [ -s "$f" ]; then
              if [ ! -s "${OUT}" ]; then
                cp "$f" "${OUT}"
              else
                tail -n +2 "$f" >> "${OUT}"
              fi
            fi
          done
          test -s "${OUT}" || { echo "::error::Nenhuma odds coletada"; exit 2; }
          # dedup por match_id preservando a primeira (priorize TheOddsAPI e depois API-Football)
          IFS=, read -r HEADER < "${OUT}"
          echo "${HEADER}" > "${TMP}"
          awk -F, 'NR>1 && !seen[$1]++ { print }' "${OUT}" >> "${TMP}"
          mv "${TMP}" "${OUT}"

      - name: Build features
        run: |
          python scripts/build_features.py --rodada "${{ env.LOTECA_RODADA }}"
          test -s "data/out/${{ env.LOTECA_RODADA }}/features.csv" || { echo "::error::features.csv ausente/vazio"; exit 2; }

      - name: Join features
        run: |
          python scripts/join_features.py --rodada "${{ env.LOTECA_RODADA }}"
          test -s "data/out/${{ env.LOTECA_RODADA }}/joined.csv" || { echo "::error::joined.csv ausente/vazio"; exit 2; }

      - name: Plan bet (cartão Loteca)
        run: |
          python scripts/plan_bet.py --rodada "${{ env.LOTECA_RODADA }}" --max-duplos 4 --max-triplos 2
          test -s "data/out/${{ env.LOTECA_RODADA }}/cartao.csv" || { echo "::error::cartao.csv não gerado"; exit 2; }

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: loteca-${{ env.LOTECA_RODADA }}
          path: |
            data/out/${{ env.LOTECA_RODADA }}/joined.csv
            data/out/${{ env.LOTECA_RODADA }}/cartao.csv
            data/out/${{ env.LOTECA_RODADA }}/odds.csv
